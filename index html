<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Imperial TECHUB ‚Äî Ngorano Parish</title>
<style>
  :root{
    --bg:#ffffff;
    --card:#f7f8fb;
    --text:#0b1220;
    --muted:#556;
    --navy:#001f3f;
    --accent:#ff2e2e;
    --glass: rgba(255,255,255,0.06);
    --radius:12px;
  }
  [data-theme="dark"]{
    --bg:#0b0f14;
    --card:#0d1116;
    --text:#e8eef6;
    --muted:#aab;
    --glass: rgba(255,255,255,0.03);
  }

  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }

  header{
    display:flex;align-items:center;justify-content:space-between;
    padding:14px 16px;border-bottom:1px solid rgba(0,0,0,0.06);
    background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    position:sticky;top:0;z-index:20;
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .logo{
    width:44px;height:44px;border-radius:8px;background:var(--navy);
    display:grid;place-items:center;color:white;font-weight:800;font-size:14px;
    box-shadow:0 3px 10px rgba(0,0,0,0.12);
  }
  .top-actions{display:flex;align-items:center;gap:10px}

  /* Fixed navy buttons across both themes */
  .btn{
    background:var(--navy);color:white;border:none;padding:8px 12px;border-radius:10px;
    cursor:pointer;font-weight:600;display:inline-flex;gap:8px;align-items:center;
    box-shadow: 0 6px 14px rgba(0,31,63,0.12);
  }
  .btn.sm{padding:6px 8px;font-size:13px;border-radius:8px}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}

  main{display:flex;gap:14px;padding:14px;flex:1;align-items:flex-start}
  .left-panel{width:260px;min-height:60vh;background:var(--card);border-radius:var(--radius);padding:12px;position:sticky;top:74px}
  .content{flex:1;min-height:60vh}
  .card{background:var(--card);padding:12px;border-radius:12px;margin-bottom:12px}

  .nav-row{display:flex;gap:8px;overflow:auto;padding:6px 0}
  .nav-item{min-width:80px;text-align:center;padding:8px;border-radius:10px;cursor:pointer}
  .nav-item.active{background:linear-gradient(180deg, rgba(0,31,63,0.08), rgba(0,0,0,0.02));font-weight:700}
  .icon{font-size:18px;margin-right:6px}

  form .field{display:flex;flex-direction:column;margin-bottom:10px}
  input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:var(--text)}
  textarea{min-height:80px;resize:vertical}

  .church-list{display:flex;flex-direction:column;gap:6px}
  .church-item{padding:8px;border-radius:8px;display:flex;justify-content:space-between;gap:8px;align-items:center}
  .small{font-size:13px;color:var(--muted)}

  .countdown{font-weight:800;font-size:18px}
  .event-card{display:flex;justify-content:space-between;align-items:center;gap:10px}

  /* simple responsive */
  @media (max-width:900px){
    main{flex-direction:column;padding:8px}
    .left-panel{width:100%;position:relative;top:0}
  }

  /* hymn / bible layout */
  .book-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px}
  .book-item{padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent)}
  .reel-thumb{width:120px;height:80px;background:#ddd;border-radius:8px;display:grid;place-items:center;color:#333}

  footer{padding:10px;text-align:center;color:var(--muted)}
</style>
</head>
<body data-theme="light">

<header>
  <div class="brand">
    <div class="logo">IT</div>
    <div>
      <div>Imperial <span style="color:var(--navy)">TECHUB</span></div>
      <div class="small">Ngorano Parish ‚Ä¢ Unified Church Platform</div>
    </div>
  </div>

  <div class="top-actions">
    <button class="btn sm" id="themeToggle">Dark</button>
    <button class="btn sm" id="openChurchMenu">‚ãØ</button>
    <div id="userArea"></div>
  </div>
</header>

<main>
  <aside class="left-panel card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700">Ngorano Parish</div>
      <div class="small">Churches</div>
    </div>

    <div class="church-list" id="churchList">
      <!-- churches inserted by JS -->
    </div>

    <hr style="opacity:0.06;margin:10px 0" />

    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">Owner Events</div>
      <button class="btn sm" id="openEventCreator">Create</button>
    </div>

    <div id="eventsArea" style="margin-top:8px"></div>

    <hr style="opacity:0.06;margin:10px 0" />
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div><strong>Calendar</strong><div class="small">Real-time</div></div>
      <div id="miniCal" class="small"></div>
    </div>
  </aside>

  <section class="content">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;flex-direction:column;">
          <div style="font-weight:800;font-size:18px">Welcome to Imperial TECHUB</div>
          <div class="small">Your parish hub ‚Äî Home, Bible study, Prayer requests, Reels & more</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div class="small">Theme: <span id="currentTheme">Light</span></div>
          <label style="display:flex;gap:6px;align-items:center">
            <input type="checkbox" id="rememberDevice" />
            <span class="small">Remember this device</span>
          </label>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="nav-row" id="mainNav">
          <div class="nav-item active" data-page="home">üè† Home</div>
          <div class="nav-item" data-page="bibleStudy">üìñ Bible Study</div>
          <div class="nav-item" data-page="prayers">ü§≤ Prayer Requests</div>
          <div class="nav-item" data-page="reels">üé• Reels</div>
          <div class="nav-item" data-page="hymnbook">üìô Hymnbook</div>
          <div class="nav-item" data-page="bible">üìì Full Bible</div>
          <div class="nav-item" data-page="chat">‚úâÔ∏è Chat</div>
        </div>
      </div>
    </div>

    <div id="pageContainer">
      <!-- content pages inserted here -->
      <div id="home" class="card page active">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Home Feed</div>
          <div class="small">Post messages and media</div>
        </div>
        <div style="margin-top:10px">
          <form id="postForm">
            <div style="display:flex;gap:8px">
              <input id="postText" placeholder="Share an announcement, thought or link..." style="flex:1" />
              <button class="btn" type="submit">Post</button>
            </div>
          </form>
        </div>

        <div id="feed" style="margin-top:12px"></div>
      </div>

      <div id="bibleStudy" class="card page" style="display:none">
        <div style="display:flex;justify-content:space-between">
          <div><strong>Bible Study</strong><div class="small">Admin posts a topic ‚Äî users comment</div></div>
          <div id="studyControls"></div>
        </div>
        <div id="studyArea" style="margin-top:8px"></div>
      </div>

      <div id="prayers" class="card page" style="display:none">
        <div style="display:flex;justify-content:space-between">
          <div><strong>Prayer Requests</strong><div class="small">Admin verifies items before publish</div></div>
          <div class="small">Pending: <span id="pendingCount">0</span></div>
        </div>

        <div style="margin-top:8px">
          <form id="prayerForm">
            <div class="field"><input id="prayerText" placeholder="Enter prayer request..." required/></div>
            <div style="display:flex;gap:8px;align-items:center">
              <label><input type="checkbox" id="isAnonymous" /> Post anonymously</label>
              <button class="btn" type="submit">Submit for review</button>
            </div>
          </form>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700">Approved Prayers</div>
          <div id="approvedPrayers" style="margin-top:8px"></div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700">Pending (Admin Review)</div>
          <div id="pendingPrayers" style="margin-top:8px"></div>
        </div>
      </div>

      <div id="reels" class="card page" style="display:none">
        <div style="display:flex;justify-content:space-between">
          <div><strong>Reels</strong><div class="small">Short videos & clips (upload simulated)</div></div>
          <div><button class="btn" id="addReelBtn">Upload</button></div>
        </div>
        <div id="reelList" style="margin-top:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px"></div>
      </div>

      <div id="hymnbook" class="card page" style="display:none">
        <div style="display:flex;justify-content:space-between">
          <div><strong>Hymnbook ‚Äî Golden Bells</strong><div class="small">Fixed & searchable</div></div>
          <div><input id="hymnSearch" placeholder="Search hymn..." /></div>
        </div>
        <div style="margin-top:12px" id="hymnList"></div>
      </div>

      <div id="bible" class="card page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Full Bible</strong><div class="small">Genesis ‚Äî Revelation (sample chapters)</div></div>
          <div><input id="bibleSearch" placeholder="Search verse or book..." /></div>
        </div>
        <div id="bibleList" style="margin-top:12px"></div>
      </div>

      <div id="chat" class="card page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Chat</strong><div class="small">DMs & Groups (local demo)</div></div>
          <div><button class="btn" id="newChatBtn">New Chat</button></div>
        </div>

        <div style="margin-top:10px;display:flex;gap:10px">
          <div style="width:260px">
            <div class="small">Conversations</div>
            <div id="convoList" style="margin-top:8px"></div>
          </div>

          <div style="flex:1">
            <div id="messageArea">
              <div class="small">Select a conversation to start</div>
            </div>

            <div id="messageComposer" style="display:none;margin-top:8px">
              <input id="messageInput" placeholder="Type message..." style="width:70%" />
              <button class="btn" id="sendMsgBtn">Send</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>
</main>

<footer>Imperial TECHUB ‚Ä¢ Ngorano Parish ‚Äî Prototype (Frontend only)</footer>

<!-- Modals and templates (hidden) -->
<div id="modals" style="display:none">
  <!-- Sign up / Login modal -->
</div>

<script>
/* -------------------------
   INITIAL DATA & HELPERS
   ------------------------- */
const churches = [
  "PCEA CHIENI",
  "PCEA HIRIGA",
  "PCEA CENTER",
  "PCEA MUKANDAMIA",
  "PCEA NGORANO",
  "PCEA GIAGACUCA"
];

const sampleHymns = [
  {id:1,title:"Hymn 1 - Praise the Lord",lyrics:"Praise the Lord, praise Him all ye people..."},
  {id:2,title:"Hymn 2 - Great is Thy Faithfulness",lyrics:"Great is Thy faithfulness, O God my Father..."},
  {id:3,title:"Hymn 3 - Blessed Assurance",lyrics:"Blessed assurance, Jesus is mine..."}
];

const sampleBible = [
  {book:"Genesis", chapter:1, verse:1, text:"In the beginning God created the heavens and the earth."},
  {book:"John", chapter:3, verse:16, text:"For God so loved the world..."},
  {book:"Psalm", chapter:23, verse:1, text:"The Lord is my shepherd; I shall not want."}
];

function uid(){ return 'u'+Math.random().toString(36).slice(2,9); }

/* -------------------------
   STORAGE LAYERS
   ------------------------- */
function load(){ 
  return {
    users: JSON.parse(localStorage.getItem('it_users')||'[]'),
    posts: JSON.parse(localStorage.getItem('it_posts')||'[]'),
    events: JSON.parse(localStorage.getItem('it_events')||'[]'),
    prayers: JSON.parse(localStorage.getItem('it_prayers')||'[]'),
    reels: JSON.parse(localStorage.getItem('it_reels')||'[]'),
    convos: JSON.parse(localStorage.getItem('it_convos')||'[]'),
  };
}
function save(state){
  localStorage.setItem('it_users', JSON.stringify(state.users||[]));
  localStorage.setItem('it_posts', JSON.stringify(state.posts||[]));
  localStorage.setItem('it_events', JSON.stringify(state.events||[]));
  localStorage.setItem('it_prayers', JSON.stringify(state.prayers||[]));
  localStorage.setItem('it_reels', JSON.stringify(state.reels||[]));
  localStorage.setItem('it_convos', JSON.stringify(state.convos||[]));
}

/* -------------------------
   APP STATE
   ------------------------- */
let state = load();
let currentUser = JSON.parse(localStorage.getItem('it_currentUser') || 'null');
const OWNER_EMAIL = "iangathagu@gmail.com"; // owner assignment (you)

// Ensure at least sample admin exists? Not required.

function setCurrentUser(u, rememberDevice=false){
  currentUser = u;
  localStorage.setItem('it_currentUser', JSON.stringify(u));
  if(rememberDevice) localStorage.setItem('it_rememberDevice', '1');
  renderUserArea();
  refreshAll();
}
function logout(){
  currentUser = null;
  localStorage.removeItem('it_currentUser');
  localStorage.removeItem('it_rememberDevice');
  renderUserArea(); refreshAll();
}

/* -------------------------
   THEME
   ------------------------- */
const body = document.body;
function applyTheme(t){
  body.setAttribute('data-theme', t);
  document.getElementById('currentTheme').innerText = t[0].toUpperCase() + t.slice(1);
  document.getElementById('themeToggle').innerText = t === 'light' ? 'Dark' : 'Light';
}
document.getElementById('themeToggle').addEventListener('click', ()=>{
  const t = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
  applyTheme(t);
});
applyTheme('light');

/* -------------------------
   RENDER CHURCH LIST / LEFT PANEL
   ------------------------- */
function renderChurchList(){
  const el = document.getElementById('churchList'); el.innerHTML='';
  churches.forEach(c=>{
    const div=document.createElement('div'); div.className='church-item';
    div.innerHTML = `<div><strong>${c}</strong><div class="small">Local posts & songs</div></div><div><button class="btn sm" onclick="openChurch('${c.replaceAll("'", "\\'")}')">Open</button></div>`;
    el.appendChild(div);
  });
  document.getElementById('miniCal').innerText = new Date().toLocaleDateString();
}
window.openChurch = function(name){
  alert('Open church page: '+name + '\\n(Each church has independent posts & admins in production.)');
}
renderChurchList();

/* -------------------------
   EVENTS (Owner-only create)
   ------------------------- */
function renderEvents(){
  const el = document.getElementById('eventsArea'); el.innerHTML='';
  const events = state.events || [];
  if(events.length===0){ el.innerHTML = '<div class="small">No events yet</div>'; return; }
  events.forEach(ev=>{
    const d = new Date(ev.date);
    const diff = Math.max(0, d - new Date());
    const days = Math.floor(diff / (1000*60*60*24));
    const hours = Math.floor((diff / (1000*60*60)) % 24);
    const mins = Math.floor((diff / (1000*60)) % 60);
    const div = document.createElement('div'); div.className='event-card';
    div.innerHTML = `<div><strong>${ev.title}</strong><div class="small">${d.toLocaleString()}</div></div>
                     <div style="text-align:right"><div class="countdown">${days}d ${hours}h ${mins}m</div>
                     ${currentUser && currentUser.isOwner ? '<button class="btn sm" onclick="deleteEvent(\\''+ev.id+'\\')">Delete</button>':''}</div>`;
    el.appendChild(div);
  });
}
window.deleteEvent = function(id){
  if(!confirm('Delete event?')) return;
  state.events = state.events.filter(e=>e.id!==id); save(state); renderEvents();
}
document.getElementById('openEventCreator').addEventListener('click', ()=>{
  if(!currentUser || !currentUser.isOwner){ alert('Only the owner can create events. Sign in as owner.'); return; }
  const title = prompt('Event title:'); if(!title) return;
  const date = prompt('Date/time (YYYY-MM-DD HH:MM) e.g. 2026-01-01 10:00'); if(!date) return;
  const ev = {id:uid(), title, date: new Date(date).toISOString(), createdBy: currentUser.email};
  state.events.unshift(ev); save(state); renderEvents();
});

/* -------------------------
   NAVIGATION + PAGES
   ------------------------- */
const navItems = document.querySelectorAll('.nav-item');
navItems.forEach(n=>{
  n.addEventListener('click', ()=>{
    document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
    n.classList.add('active');
    const page = n.dataset.page;
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    document.getElementById(page).style.display='block';
  });
});

/* -------------------------
   USER AREA (signup/login & profile)
   ------------------------- */
function renderUserArea(){
  const area = document.getElementById('userArea');
  area.innerHTML='';
  if(!currentUser){
    const btn = document.createElement('button'); btn.className='btn sm'; btn.innerText='Sign Up / Login';
    btn.onclick = openAuthModal;
    area.appendChild(btn);
  } else {
    const div = document.createElement('div'); div.style.display='flex';div.style.alignItems='center';div.style.gap='8px';
    div.innerHTML = `<div style="text-align:right"><div style="font-weight:700">${currentUser.fullName||currentUser.username||currentUser.email}</div><div class="small">${currentUser.church||''}</div></div>`;
    const out = document.createElement('button'); out.className='btn sm'; out.innerText='Logout';
    out.onclick = ()=>{ if(confirm('Logout?')) logout(); };
    div.appendChild(out);
    area.appendChild(div);
  }
}
renderUserArea();

/* -------------------------
   AUTH (Signup & Login)
   ------------------------- */
function openAuthModal(){
  const html = `
    <div style="padding:12px;max-width:520px">
      <h3>Sign up / Login</h3>
      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <form id="signupForm">
            <div class="field"><label>Full name</label><input id="su_full" required /></div>
            <div class="field"><label>Username (optional)</label><input id="su_username" /></div>
            <div class="field"><label>Phone number</label><input id="su_phone" required /></div>
            <div class="field"><label>Email address</label><input id="su_email" type="email" required /></div>
            <div class="field"><label>Church</label>
              <select id="su_church">${churches.map(c=>`<option value="${c}">${c}</option>`).join('')}</select>
            </div>
            <div class="field"><label>District</label><input id="su_district" /></div>
            <div class="field"><label>Full Member?</label>
              <select id="su_member"><option value="yes">Yes</option><option value="no">No</option></select>
            </div>
            <div class="field"><label>Date of birth</label><input id="su_dob" type="date" /></div>
            <div class="field"><label>Password</label><input id="su_pwd" type="password" required /></div>
            <div class="field"><label>Confirm password</label><input id="su_pwd2" type="password" required /></div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn" type="submit">Create account</button>
              <button class="btn ghost" id="googleSignin">Continue with Google</button>
            </div><h4>Quick Login</h4>
          <form id="loginForm">
            <div class="field"><label>Email or Phone</label><input id="li_user" required /></div>
            <div class="field"><label>Password</label><input id="li_pwd" type="password" required /></div>
            <div style="display:flex;gap:8px"><button class="btn" type="submit">Login</button><button class="btn ghost" id="loginCode">Login with code</button></div>
            <div class="small" style="margin-top:8px">Tip: Sign up and check "Remember this device" for faster access on this device.</div>
          </form>
        </div>
      </div>
    </div>
  `;
  const w = window.open('', 'auth','width=820,height=640');
  w.document.title = "Sign up / Login - Imperial TECHUB";
  w.document.body.innerHTML = html;
  w.document.body.style.fontFamily = document.body.style.fontFamily;
  // attach handlers
  w.document.getElementById('signupForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const full = w.document.getElementById('su_full').value.trim();
    const username = w.document.getElementById('su_username').value.trim();
    const phone = w.document.getElementById('su_phone').value.trim();
    const email = w.document.getElementById('su_email').value.trim();
    const church = w.document.getElementById('su_church').value;
    const district = w.document.getElementById('su_district').value;
    const member = w.document.getElementById('su_member').value;
    const dob = w.document.getElementById('su_dob').value;
    const pwd = w.document.getElementById('su_pwd').value;
    const pwd2 = w.document.getElementById('su_pwd2').value;
    if(pwd !== pwd2){ alert('Passwords do not match'); return; }
    // save user
    const existing = state.users.find(u => u.email === email || u.phone === phone);
    if(existing){ alert('Account already exists with that email or phone. Login instead.'); return; }
    const user = {id: uid(), fullName: full, username, phone, email, church, district, member, dob, password: pwd};
    // owner auto-assign
    if(email.toLowerCase() === OWNER_EMAIL) user.isOwner = true;
    // add to list
    state.users.push(user); save(state);
    alert('Account created! You will be logged in on this device.');
    // remember device?
    const remember = localStorage.getItem('it_rememberDevice') === '1';
    setCurrentUser(user, remember);
    w.close();
  });
  w.document.getElementById('googleSignin').addEventListener('click', (ev)=>{
    ev.preventDefault();
    alert('This is a demo Google Sign-In. In production, integrate Google OAuth.');
    // simulate
    const googleEmail = prompt('Google email:');
    if(!googleEmail) return;
    // find or create
    let user = state.users.find(u => u.email === googleEmail);
    if(!user){
      user = {id: uid(), fullName: googleEmail.split('@')[0], email: googleEmail, username: googleEmail.split('@')[0]};
      if(googleEmail.toLowerCase()===OWNER_EMAIL) user.isOwner = true;
      state.users.push(user); save(state);
    }
    setCurrentUser(user, true);
    w.close();
  });
  w.document.getElementById('loginForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const who = w.document.getElementById('li_user').value.trim();
    const pwd = w.document.getElementById('li_pwd').value;
    const user = state.users.find(u => u.email===who || u.phone===who || u.username===who);
    if(!user){ alert('No account found; sign up first.'); return; }
    if(user.password !== pwd){ alert('Wrong password'); return; }
    setCurrentUser(user, true);
    w.close();
  });
  w.document.getElementById('loginCode').addEventListener('click', (ev)=>{
    ev.preventDefault();
    const who = w.document.getElementById('li_user').value.trim();
    const user = state.users.find(u => u.email===who || u.phone===who || u.username===who);
    if(!user){ alert('No account found'); return; }
    // simulated verification code
    const code = Math.floor(100000 + Math.random()*900000);
    alert('Simulated verification code (would be sent via SMS/Email): ' + code);
    const entered = prompt('Enter the verification code:');
    if(entered == code){
      setCurrentUser(user, true);
      w.close();
    } else alert('Wrong code');
  });
  w.document.getElementById('showLogin').addEventListener('click', (e)=>{ e.preventDefault(); w.scrollTo({top:0,behavior:"smooth"}); });
}

/* -------------------------
   POSTS (Home feed)
   ------------------------- */
document.getElementById('postForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  if(!currentUser){ alert('Sign in to post'); return; }
  const text = document.getElementById('postText').value.trim();
  if(!text) return;
  const p = {id: uid(), text, author: currentUser.fullName||currentUser.username||currentUser.email, time: new Date().toISOString()};
  state.posts.unshift(p); save(state);
  document.getElementById('postText').value='';
  renderFeed();
});
function renderFeed(){
  const el = document.getElementById('feed'); el.innerHTML='';
  (state.posts||[]).forEach(p=>{
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${p.author}</strong><div class="small">${new Date(p.time).toLocaleString()}</div></div>${(currentUser && (currentUser.isOwner))?'<button class="btn sm" onclick="deletePost(\\''+p.id+'\\')">Delete</button>':''}</div><div style="margin-top:8px">${escapeHtml(p.text)}</div>`;
    el.appendChild(div);
  });
}
window.deletePost = function(id){
  if(!confirm('Delete post?')) return;
  state.posts = state.posts.filter(p=>p.id!==id); save(state); renderFeed();
}
function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
renderFeed();

/* -------------------------
   BIBLE STUDY
   ------------------------- */
function renderStudy(){
  const area = document.getElementById('studyArea'); area.innerHTML='';
  const study = JSON.parse(localStorage.getItem('it_study')||'null');
  if(!study){ area.innerHTML = '<div class="small">No active study. Admin can post a verse/topic.</div>'; } else {
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;">
      <div><strong>${study.title}</strong><div class="small">${new Date(study.created).toLocaleString()}</div></div>
      ${currentUser && currentUser.isOwner ? '<button class="btn sm" onclick="clearStudy()">Clear</button>' : ''}
    </div>
    <div style="margin-top:8px">${escapeHtml(study.body)}</div>
    <div style="margin-top:8px"><strong>Comments</strong><div id="studyComments"></div></div>`;
    area.appendChild(div);

    const comments = study.comments || [];
    const commentsEl = div.querySelector('#studyComments');
    comments.forEach(c=>{
      const ce = document.createElement('div'); ce.className='card';
      ce.innerHTML = `<div><strong>${c.author}</strong> <span class="small">${new Date(c.time).toLocaleString()}</span></div><div>${escapeHtml(c.text)}</div>`;
      commentsEl.appendChild(ce);
    });
    // comment form
    if(currentUser){
      const form = document.createElement('form'); form.style.marginTop='8px';
      form.innerHTML = `<div style="display:flex;gap:8px"><input placeholder="Add comment..." style="flex:1" id="studyCommentInput" /><button class="btn">Comment</button></div>`;
      form.addEventListener('submit',(e)=>{ e.preventDefault(); const v = form.querySelector('#studyCommentInput').value.trim(); if(!v) return; study.comments = study.comments || []; study.comments.push({author: currentUser.fullName||currentUser.username||currentUser.email, time:new Date().toISOString(), text:v}); localStorage.setItem('it_study', JSON.stringify(study)); renderStudy(); });
      area.appendChild(form);
    }
  }
  const controls = document.getElementById('studyControls'); controls.innerHTML='';
  if(currentUser && currentUser.isOwner){
    const b = document.createElement('button'); b.className='btn sm'; b.innerText='Post Study'; b.onclick = ()=> {
      const title = prompt('Study title (verse/topic):'); if(!title) return;
      const body = prompt('Post body or verse:'); if(!body) return;
      const studyData = {title, body, created: new Date().toISOString(), author: currentUser.email, comments:[]};
      localStorage.setItem('it_study', JSON.stringify(studyData));
      renderStudy();
    };
    controls.appendChild(b);
  }
}
function clearStudy(){ if(confirm('Clear current study?')){ localStorage.removeItem('it_study'); renderStudy(); } }
renderStudy();/* -------------------------
   PRAYER REQUESTS (admin approval)
   ------------------------- */
document.getElementById('prayerForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  if(!currentUser){ alert('Sign in to submit prayer requests'); return; }
  const text = document.getElementById('prayerText').value.trim();
  const anon = document.getElementById('isAnonymous').checked;
  if(!text) return;
  const pr = {id: uid(), text, author: anon ? 'Anonymous' : (currentUser.fullName||currentUser.username||currentUser.email), submittedBy: currentUser.email, approved:false, time:new Date().toISOString()};
  state.prayers.push(pr); save(state);
  document.getElementById('prayerText').value=''; document.getElementById('isAnonymous').checked=false;
  refreshPrayers();
  alert('Prayer submitted ‚Äî pending admin verification.');
});
function refreshPrayers(){
  const approvedEl = document.getElementById('approvedPrayers'); approvedEl.innerHTML='';
  const pendingEl = document.getElementById('pendingPrayers'); pendingEl.innerHTML='';
  (state.prayers || []).filter(p=>p.approved).forEach(p=>{
    const d = document.createElement('div'); d.className='card'; d.innerHTML = `<div><strong>${p.author}</strong> <span class="small">${new Date(p.time).toLocaleString()}</span></div><div style="margin-top:6px">${escapeHtml(p.text)}</div>`;
    approvedEl.appendChild(d);
  });
  const pending = (state.prayers||[]).filter(p=>!p.approved);
  document.getElementById('pendingCount').innerText = pending.length;
  pending.forEach(p=>{
    const d = document.createElement('div'); d.className='card';
    const approveBtn = `<button class="btn sm" onclick="approvePrayer('${p.id}')">Approve</button>`;
    const delBtn = `<button class="btn sm" onclick="deletePrayer('${p.id}')">Delete</button>`;
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${p.author}</strong> <div class="small">${new Date(p.time).toLocaleString()}</div></div><div>${(currentUser && currentUser.isOwner) ? approveBtn + delBtn : '<span class="small">Pending admin</span>'}</div></div><div style="margin-top:6px">${escapeHtml(p.text)}</div>`;
    pendingEl.appendChild(d);
  });
}
window.approvePrayer = function(id){
  if(!currentUser || !currentUser.isOwner){ alert('Only admin can approve'); return; }
  state.prayers = state.prayers.map(p => p.id===id ? {...p, approved:true} : p); save(state); refreshPrayers();
}
window.deletePrayer = function(id){
  if(!currentUser || !currentUser.isOwner){ alert('Only admin can delete'); return; }
  if(!confirm('Delete prayer?')) return;
  state.prayers = state.prayers.filter(p=>p.id!==id); save(state); refreshPrayers();
}
refreshPrayers();

/* -------------------------
   REELS (simple)
   ------------------------- */
document.getElementById('addReelBtn').addEventListener('click', ()=>{
  if(!currentUser){ alert('Sign in to upload a reel'); return; }
  const title = prompt('Reel title/description'); if(!title) return;
  const reel = {id:uid(), title, author: currentUser.fullName||currentUser.email, time: new Date().toISOString()};
  state.reels.unshift(reel); save(state); renderReels();
});
function renderReels(){
  const el = document.getElementById('reelList'); el.innerHTML='';
  (state.reels || []).forEach(r=>{
    const d = document.createElement('div'); d.className='card';
    d.innerHTML = `<div style="display:flex;gap:10px"><div class="reel-thumb">üé¨</div><div style="flex:1"><div style="display:flex;justify-content:space-between"><div><strong>${r.title}</strong><div class="small">${r.author}</div></div>${currentUser && currentUser.isOwner?'<button class="btn sm" onclick="deleteReel(\\''+r.id+'\\')">Remove</button>':''}</div></div></div>`;
    el.appendChild(d);
  });
}
window.deleteReel = function(id){
  if(!confirm('Remove reel?')) return;
  state.reels = state.reels.filter(r=>r.id!==id); save(state); renderReels();
}
renderReels();

/* -------------------------
   HYMNBOOK & BIBLE (static sample)
   ------------------------- */
function renderHymns(){
  const el = document.getElementById('hymnList'); el.innerHTML='';
  sampleHymns.forEach(h=>{
    const d = document.createElement('div'); d.className='card';
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${h.title}</strong></div><div><button class="btn sm" onclick="viewHymn(${h.id})">Open</button></div></div>`;
    el.appendChild(d);
  });
}
window.viewHymn = function(id){
  const h = sampleHymns.find(x=>x.id===id);
  if(!h) return;
  const w = window.open('', '_blank','width=600,height=500'); w.document.title = h.title; w.document.body.innerHTML = '<pre style="white-space:pre-wrap;font-family:inherit;padding:16px">'+h.title+'\\n\\n'+h.lyrics+'</pre>';
}
document.getElementById('hymnSearch').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  const filtered = sampleHymns.filter(h=>h.title.toLowerCase().includes(q) || h.lyrics.toLowerCase().includes(q));
  document.getElementById('hymnList').innerHTML = filtered.map(h=>`<div class="card"><div style="display:flex;justify-content:space-between"><div><strong>${h.title}</strong></div><div><button class="btn sm" onclick="viewHymn(${h.id})">Open</button></div></div></div>`).join('');
});
renderHymns();

function renderBible(){
  const el = document.getElementById('bibleList'); el.innerHTML='';
  sampleBible.forEach(b=>{
    const d = document.createElement('div'); d.className='card';
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${b.book} ${b.chapter}:${b.verse}</strong><div class="small">${b.text}</div></div><div><button class="btn sm" onclick="copyText('${escapeForJs(b.text)}')">Copy</button></div></div>`;
    el.appendChild(d);
  });
}
function escapeForJs(s){ return s.replaceAll("'", "\\'").replaceAll('"','\\"'); }
function copyText(t){ navigator.clipboard?.writeText(t).then(()=>alert('Copied')); }
document.getElementById('bibleSearch').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  const filtered = sampleBible.filter(b=>b.text.toLowerCase().includes(q) || b.book.toLowerCase().includes(q));
  document.getElementById('bibleList').innerHTML = filtered.map(b=>`<div class="card"><div style="display:flex;justify-content:space-between"><div><strong>${b.book} ${b.chapter}:${b.verse}</strong><div class="small">${b.text}</div></div><div><button class="btn sm" onclick="copyText('${escapeForJs(b.text)}')">Copy</button></div></div></div>`).join('');
});
renderBible();/* -------------------------
   SIMPLE CHAT (local)
   ------------------------- */
function renderConvos(){
  const el = document.getElementById('convoList'); el.innerHTML='';
  (state.convos || []).forEach(c=>{
    const d = document.createElement('div'); d.className='card';
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${c.name}</strong><div class="small">${(c.members||[]).length} members</div></div><div><button class="btn sm" onclick="openConvo('${c.id}')">Open</button></div></div>`;
    el.appendChild(d);
  });
}
document.getElementById('newChatBtn').addEventListener('click', ()=>{
  if(!currentUser){ alert('Sign in to start a chat'); return; }
  const name = prompt('Conversation name (person or group):'); if(!name) return;
  const membersRaw = prompt('Members (comma-separated emails) ‚Äî include your email to be added:','');
  const members = (membersRaw||'').split(',').map(s=>s.trim()).filter(Boolean);
  if(!members.includes(currentUser.email)) members.push(currentUser.email);
  const convo = {id: uid(), name, members, messages: []};
  state.convos.push(convo); save(state); renderConvos();
});
window.openConvo = function(id){
  const convo = state.convos.find(c=>c.id===id);
  if(!convo) return;
  // show messages
  document.getElementById('messageArea').innerHTML = `<div style="font-weight:700">${convo.name}</div><div id="msgs" style="margin-top:8px"></div>`;
  const msgs = convo.messages || [];
  const msgsEl = document.getElementById('msgs');
  msgs.forEach(m=>{
    const dd = document.createElement('div'); dd.className='card'; dd.innerHTML = `<div style="font-weight:700">${m.sender} <span class="small">${new Date(m.time).toLocaleString()}</span></div><div>${escapeHtml(m.text)}</div>`;
    msgsEl.appendChild(dd);
  });
  document.getElementById('messageComposer').style.display='flex';
  document.getElementById('sendMsgBtn').onclick = ()=>{
    const txt = document.getElementById('messageInput').value.trim();
    if(!txt) return;
    convo.messages.push({id:uid(), sender: currentUser.fullName||currentUser.email, time:new Date().toISOString(), text:txt});
    save(state); openConvo(id);
    document.getElementById('messageInput').value='';
  };
}
renderConvos();

/* -------------------------
   BOOTSTRAP / REFRESH
   ------------------------- */
function refreshAll(){
  state = load();
  renderUserArea();
  renderEvents();
  renderFeed();
  renderStudy();
  refreshPrayers();
  renderReels();
  renderHymns();
  renderBible();
  renderConvos();
}
refreshAll();

/* Auto-login if remembered on this device */
if(localStorage.getItem('it_rememberDevice') === '1' && localStorage.getItem('it_currentUser')){
  currentUser = JSON.parse(localStorage.getItem('it_currentUser'));
  renderUserArea();
  refreshAll();
}

/* -------------------------
   UTILITIES
   ------------------------- */
window.addEventListener('storage', (e)=>{ refreshAll(); });

/* Simple helper to show left menu when top-left button pressed */
document.getElementById('openChurchMenu').addEventListener('click', ()=>{
  alert('Church list:\\n' + churches.join('\\n') + '\\n\\nAlso: Events and Calendar below the list.');
});

/* small helper for owner demonstration: when signing up with OWNER_EMAIL, user becomes owner */
console.log('Imperial TECHUB demo loaded. Owner email: ', OWNER_EMAIL);
</script>
</body>
</html>
